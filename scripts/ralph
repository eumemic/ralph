#!/bin/bash
# Ralph - Spec-to-Code Synchronization Engine
#
# Usage:
#   ralph plan [max_iterations]    # Run planning loop
#   ralph build [max_iterations]   # Run building loop
#   ralph init                     # Initialize Ralph in current project
#   ralph --help                   # Show help

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_ROOT="$(dirname "$SCRIPT_DIR")"

# Defaults (can be overridden via environment variables)
: "${RALPH_MODEL:=opus}"
: "${RALPH_SUBAGENT_MODEL:=sonnet}"

# Project paths (relative to current working directory)
RALPH_DIR=".ralph"
PLAN_FILE="$RALPH_DIR/IMPLEMENTATION_PLAN.md"
CONFIG_FILE="$RALPH_DIR/config.yaml"

show_help() {
    cat <<'EOF'
Ralph - Spec-to-Code Synchronization Engine

Usage:
  ralph plan [max_iterations]    Run the planning loop (gap analysis)
  ralph build [max_iterations]   Run the building loop (implementation)
  ralph init                     Initialize Ralph in the current project
  ralph --help                   Show this help

Examples:
  ralph init                     Set up specs/ and .ralph/ directories
  ralph plan                     Analyze specs and generate implementation plan
  ralph plan 5                   Run max 5 planning iterations
  ralph build                    Implement tasks from the plan
  ralph build 20                 Run max 20 build iterations

Environment Variables:
  RALPH_MODEL          Model for main agent (default: opus)
  RALPH_SUBAGENT_MODEL Model for subagents (default: sonnet)

The Ralph Workflow:
  1. Write specifications in specs/ (or configured location)
  2. Run 'ralph plan' to generate .ralph/IMPLEMENTATION_PLAN.md
  3. Run 'ralph build' to implement tasks one at a time
  4. Repeat as specs evolve

Learn more: https://github.com/eumemic/ralph
EOF
}

# Read specs_dir from config, default to ./specs
get_specs_dir() {
    if [ -f "$CONFIG_FILE" ]; then
        local dir=$(grep -E '^specs_dir:' "$CONFIG_FILE" 2>/dev/null | sed 's/specs_dir:[[:space:]]*//' | tr -d '"'"'" || echo "")
        if [ -n "$dir" ]; then
            echo "$dir"
            return
        fi
    fi
    echo "./specs"
}

# Get hash of plan file (empty string if doesn't exist)
get_plan_hash() {
    if [ -f "$PLAN_FILE" ]; then
        md5 -q "$PLAN_FILE" 2>/dev/null || md5sum "$PLAN_FILE" 2>/dev/null | cut -d' ' -f1 || echo ""
    else
        echo ""
    fi
}

# Check if plan has pending tasks (unchecked markdown checkboxes)
plan_has_pending_tasks() {
    if [ -f "$PLAN_FILE" ]; then
        grep -q '^\s*- \[ \]' "$PLAN_FILE"
    else
        return 1
    fi
}

run_loop() {
    local MODE="$1"
    local MAX_ITERATIONS="${2:-0}"
    local PROMPT_FILE="$PLUGIN_ROOT/prompts/PROMPT_${MODE}.md"
    local SPECS_DIR=$(get_specs_dir)

    # Check prerequisites
    if [ ! -d "$RALPH_DIR" ]; then
        echo "Error: Ralph not initialized. Run 'ralph init' first."
        exit 1
    fi

    if [ ! -d "$SPECS_DIR" ]; then
        echo "Error: Specs directory not found: $SPECS_DIR"
        echo "Create it or update specs_dir in $CONFIG_FILE"
        exit 1
    fi

    if [ ! -f "$PROMPT_FILE" ]; then
        echo "Error: Prompt file not found: $PROMPT_FILE"
        exit 1
    fi

    local ITERATION=0
    local CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "not a git repo")

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Ralph - $MODE mode"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Model:     $RALPH_MODEL (subagents: $RALPH_SUBAGENT_MODEL)"
    echo "Specs:     $SPECS_DIR"
    echo "Plan:      $PLAN_FILE"
    echo "Branch:    $CURRENT_BRANCH"
    if [ $MAX_ITERATIONS -gt 0 ]; then
        echo "Max:       $MAX_ITERATIONS iterations"
    else
        echo "Max:       unlimited"
    fi
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    while true; do
        if [ $MAX_ITERATIONS -gt 0 ] && [ $ITERATION -ge $MAX_ITERATIONS ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Reached max iterations: $MAX_ITERATIONS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi

        # Build mode: check if all tasks are complete
        if [ "$MODE" = "build" ] && ! plan_has_pending_tasks; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "All tasks complete - build finished"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi

        ITERATION=$((ITERATION + 1))
        local PLAN_HASH_BEFORE=$(get_plan_hash)

        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        printf "           ITERATION %-17s\n" "$ITERATION"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""

        # Prepare environment for envsubst
        export RALPH_SUBAGENT_MODEL
        export SPECS_DIR
        export PLAN_FILE

        # Run Claude with the prompt
        envsubst < "$PROMPT_FILE" | claude -p \
            --dangerously-skip-permissions \
            --model "$RALPH_MODEL" \
            --output-format stream-json \
            --verbose \
            | "$PLUGIN_ROOT/scripts/stream-progress.sh"

        # Check if plan changed (for planning mode termination)
        local PLAN_HASH_AFTER=$(get_plan_hash)
        if [ "$MODE" = "plan" ] && [ "$PLAN_HASH_BEFORE" = "$PLAN_HASH_AFTER" ] && [ -n "$PLAN_HASH_BEFORE" ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Plan unchanged - planning complete"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi
    done
}

# Main command dispatch
case "${1:-}" in
    init)
        exec bash "$PLUGIN_ROOT/scripts/init.sh" "${@:2}"
        ;;
    plan)
        run_loop "plan" "${2:-0}"
        ;;
    build)
        run_loop "build" "${2:-0}"
        ;;
    -h|--help|help)
        show_help
        exit 0
        ;;
    "")
        show_help
        exit 0
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo "Run 'ralph --help' for usage."
        exit 1
        ;;
esac
