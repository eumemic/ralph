#!/bin/bash
# Ralph - Spec-to-Code Synchronization Engine
#
# Usage:
#   ralph plan [max_iterations]           # Run planning loop (full scope)
#   ralph plan "scope" [max_iterations]   # Run planning loop (scoped to work)
#   ralph build [max_iterations]          # Run building loop
#   ralph --help                          # Show help

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_ROOT="$(dirname "$SCRIPT_DIR")"

# Model allocation (hardcoded per original methodology)
RALPH_MODEL="opus"

# Project paths (relative to current working directory)
RALPH_DIR=".ralph"
PLAN_FILE="$RALPH_DIR/IMPLEMENTATION_PLAN.md"
AGENTS_FILE="$RALPH_DIR/AGENTS.md"
CONFIG_FILE="$RALPH_DIR/config.yaml"

show_help() {
    cat <<'EOF'
Ralph - Spec-to-Code Synchronization Engine

Usage:
  ralph plan [max_iterations]           Run planning loop (full scope)
  ralph plan "scope" [max_iterations]   Run planning loop (scoped to work)
  ralph build [max_iterations]          Run building loop (implementation)
  ralph --help                          Show this help

Examples:
  ralph plan                     Analyze specs and generate implementation plan
  ralph plan 5                   Run max 5 planning iterations
  ralph plan "user auth"         Plan only tasks related to user authentication
  ralph plan "OAuth login" 3     Scoped planning, max 3 iterations
  ralph build                    Implement tasks from the plan
  ralph build 20                 Run max 20 build iterations

Initialize a new project:
  Use /ralph-init in Claude Code for interactive setup

The Ralph Workflow:
  1. Run /ralph-init to set up specs/ and .ralph/
  2. Write specifications in specs/
  3. Run 'ralph plan' to generate .ralph/IMPLEMENTATION_PLAN.md
  4. Run 'ralph build' to implement tasks one at a time
  5. Repeat as specs evolve

Learn more: https://github.com/eumemic/ralph
EOF
}

# Read specs_dir from config, default to ./specs
get_specs_dir() {
    if [ -f "$CONFIG_FILE" ]; then
        local dir=$(grep -E '^specs_dir:' "$CONFIG_FILE" 2>/dev/null | sed 's/specs_dir:[[:space:]]*//' | tr -d '"'"'" || echo "")
        if [ -n "$dir" ]; then
            echo "$dir"
            return
        fi
    fi
    echo "./specs"
}

# Read shared_utils_dir from config, default to ./src/lib
get_shared_utils_dir() {
    if [ -f "$CONFIG_FILE" ]; then
        local dir=$(grep -E '^shared_utils_dir:' "$CONFIG_FILE" 2>/dev/null | sed 's/shared_utils_dir:[[:space:]]*//' | tr -d '"'"'" || echo "")
        if [ -n "$dir" ]; then
            echo "$dir"
            return
        fi
    fi
    echo "./src/lib"
}

# Read boolean config value (returns "true" or "false")
get_config_bool() {
    local key="$1"
    local default="${2:-false}"
    if [ -f "$CONFIG_FILE" ]; then
        local val=$(grep -E "^${key}:" "$CONFIG_FILE" 2>/dev/null | sed "s/${key}:[[:space:]]*//" | tr -d '"'"'" || echo "")
        if [ "$val" = "true" ]; then
            echo "true"
            return
        fi
    fi
    echo "$default"
}

# Get hash of plan file (empty string if doesn't exist)
get_plan_hash() {
    if [ -f "$PLAN_FILE" ]; then
        md5 -q "$PLAN_FILE" 2>/dev/null || md5sum "$PLAN_FILE" 2>/dev/null | cut -d' ' -f1 || echo ""
    else
        echo ""
    fi
}

# Check if plan has pending tasks (unchecked markdown checkboxes)
plan_has_pending_tasks() {
    if [ -f "$PLAN_FILE" ]; then
        grep -q '^\s*- \[ \]' "$PLAN_FILE"
    else
        return 1
    fi
}

run_loop() {
    local MODE="$1"
    local MAX_ITERATIONS="${2:-0}"
    local WORK_SCOPE="${3:-}"
    local PROMPT_FILE="$PLUGIN_ROOT/prompts/PROMPT_${MODE}.md"
    local SPECS_DIR=$(get_specs_dir)
    local SHARED_UTILS_DIR=$(get_shared_utils_dir)
    local AUTO_PUSH=$(get_config_bool "auto_push" "false")
    local AUTO_TAG=$(get_config_bool "auto_tag" "false")

    # Build scope instruction for planning
    local SCOPE_INSTRUCTION="Sync the codebase to match the specifications. "
    if [ -n "$WORK_SCOPE" ]; then
        SCOPE_INSTRUCTION="Focus on: \"$WORK_SCOPE\". Only plan tasks related to this scope. "
    fi

    # Build conditional instructions for prompts
    local AUTO_PUSH_INSTRUCTION=""
    local AUTO_TAG_INSTRUCTION=""
    if [ "$AUTO_PUSH" = "true" ]; then
        AUTO_PUSH_INSTRUCTION="After the commit, \`git push\`."
    fi
    if [ "$AUTO_TAG" = "true" ]; then
        AUTO_TAG_INSTRUCTION="When no build/test errors, create a git tag (start at 0.0.0, increment patch)."
    fi

    # Check prerequisites
    if [ ! -d "$RALPH_DIR" ]; then
        echo "Error: Ralph not initialized. Run 'ralph init' first."
        exit 1
    fi

    if [ ! -d "$SPECS_DIR" ]; then
        echo "Error: Specs directory not found: $SPECS_DIR"
        echo "Create it or update specs_dir in $CONFIG_FILE"
        exit 1
    fi

    if [ ! -f "$PROMPT_FILE" ]; then
        echo "Error: Prompt file not found: $PROMPT_FILE"
        exit 1
    fi

    local ITERATION=0
    local CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "not a git repo")

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Ralph - $MODE mode"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Model:     $RALPH_MODEL"
    echo "Specs:     $SPECS_DIR"
    echo "Plan:      $PLAN_FILE"
    echo "Agents:    $AGENTS_FILE"
    echo "Branch:    $CURRENT_BRANCH"
    if [ -n "$WORK_SCOPE" ]; then
        echo "Scope:     $WORK_SCOPE"
    fi
    if [ "$AUTO_PUSH" = "true" ] || [ "$AUTO_TAG" = "true" ]; then
        echo "Git:       auto_push=$AUTO_PUSH, auto_tag=$AUTO_TAG"
    fi
    if [ $MAX_ITERATIONS -gt 0 ]; then
        echo "Max:       $MAX_ITERATIONS iterations"
    else
        echo "Max:       unlimited"
    fi

    while true; do
        if [ $MAX_ITERATIONS -gt 0 ] && [ $ITERATION -ge $MAX_ITERATIONS ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Reached max iterations: $MAX_ITERATIONS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi

        # Build mode: check if all tasks are complete
        if [ "$MODE" = "build" ] && ! plan_has_pending_tasks; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "All tasks complete - build finished"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi

        ITERATION=$((ITERATION + 1))
        local PLAN_HASH_BEFORE=$(get_plan_hash)

        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        printf "           ITERATION %-17s\n" "$ITERATION"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""

        # Prepare environment for envsubst
        export SPECS_DIR
        export PLAN_FILE
        export AGENTS_FILE
        export SHARED_UTILS_DIR
        export AUTO_PUSH_INSTRUCTION
        export AUTO_TAG_INSTRUCTION
        export SCOPE_INSTRUCTION

        # Run Claude with the prompt
        envsubst < "$PROMPT_FILE" | claude -p \
            --dangerously-skip-permissions \
            --model "$RALPH_MODEL" \
            --output-format stream-json \
            --verbose \
            | "$PLUGIN_ROOT/scripts/stream-progress.sh"

        # Check if plan changed (for planning mode termination)
        local PLAN_HASH_AFTER=$(get_plan_hash)
        if [ "$MODE" = "plan" ] && [ "$PLAN_HASH_BEFORE" = "$PLAN_HASH_AFTER" ] && [ -n "$PLAN_HASH_BEFORE" ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Plan unchanged - planning complete"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            break
        fi
    done
}

# Main command dispatch
case "${1:-}" in
    init)
        echo "Error: 'ralph init' has been removed."
        echo ""
        echo "Use /ralph-init in Claude Code for interactive setup."
        echo "This provides a better experience with project detection"
        echo "and configuration of your test/lint/typecheck commands."
        exit 1
        ;;
    plan)
        # Check if second arg is a number (max_iterations) or a string (scope)
        if [[ "${2:-}" =~ ^[0-9]+$ ]]; then
            # ralph plan 5
            run_loop "plan" "${2:-0}" ""
        elif [ -n "${2:-}" ]; then
            # ralph plan "scope" [max_iterations]
            run_loop "plan" "${3:-0}" "$2"
        else
            # ralph plan
            run_loop "plan" "0" ""
        fi
        ;;
    build)
        run_loop "build" "${2:-0}"
        ;;
    -h|--help|help)
        show_help
        exit 0
        ;;
    "")
        show_help
        exit 0
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo "Run 'ralph --help' for usage."
        exit 1
        ;;
esac
